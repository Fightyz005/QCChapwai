@model QcChapWai.Models.InspectionChecklist
@{
    ViewData["Title"] = "สร้างใบตรวจสอบใหม่";
}
<style>
    .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .bi-person-check,
    .bi-person-check-fill {
        color: #0d6efd;
    }
</style>
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="fw-bold text-dark mb-1">
            <i class="bi bi-plus-circle text-primary me-2"></i>
            สร้างใบตรวจสอบใหม่
        </h1>
        <p class="text-muted mb-0">เริ่มต้นสร้างใบตรวจสอบคุณภาพระหว่างกระบวนการผลิต</p>
    </div>

    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>
        กลับไปรายการ
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <form asp-action="Create" method="post" class="needs-validation" novalidate id="checklistForm">
            <!-- ✅ Production Order Input -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-search me-2"></i>
                        ค้นหา Production Order
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Production Order Number <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text"
                                       asp-for="ProductionOrder"
                                       class="form-control"
                                       id="productionOrderInput"
                                       placeholder="กรอก Production Order Number"
                                       required>
                                <button type="button"
                                        class="btn btn-primary"
                                        id="searchButton"
                                        onclick="validateProductionOrder()">
                                    <i class="bi bi-search me-1"></i>
                                    ค้นหา
                                </button>
                            </div>
                            <span asp-validation-for="ProductionOrder" class="text-danger"></span>

                            <!-- ✅ Validation Status -->
                            <div id="validationStatus" class="mt-2" style="display: none;">
                                <div class="alert mb-0" role="alert" id="validationAlert"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Information -->
            <div class="card mt-4 d-none" id="productCard">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-box-seam me-2"></i>
                        ข้อมูลสินค้า
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Sales Order</label>
                            <input asp-for="SoNumber" class="form-control" id="soNumber" readonly>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Sales Order Item</label>
                            <input asp-for="SalesOrderItem" class="form-control" id="soItem" readonly>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Customer Code</label>
                            <input asp-for="CustomerCode" class="form-control" id="customerCode" readonly>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Customer Name <span class="text-danger">*</span></label>
                            <input asp-for="Customer" class="form-control" id="customerName" required readonly>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Material Code (FG Code) <span class="text-danger">*</span></label>
                            <input asp-for="FgCode" class="form-control" id="materialCode" required readonly>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Material Name <span class="text-danger">*</span></label>
                            <input asp-for="ItemName" class="form-control" id="materialName" required readonly>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Size</label>
                            <input asp-for="Size" class="form-control" id="size" readonly>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Film Type</label>
                            <input asp-for="TypeOfFilm" class="form-control" id="filmType" readonly>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Plant <span class="text-danger">*</span></label>
                            <input asp-for="Plant" class="form-control" id="plant" value="KB01" required readonly>
                        </div>

                        <!-- ✅ Machine Master Selection -->
                        <div class="col-md-4">
                            <label class="form-label">Zone <span class="text-danger">*</span></label>
                            <select asp-for="MachineZone" class="form-select" id="machineZone" required onchange="loadProcesses()">
                                <option value="">-- เลือก Zone --</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Process <span class="text-danger">*</span></label>
                            <select asp-for="MachineProcess" class="form-select" id="machineProcess" required onchange="loadMachines()" disabled>
                                <option value="">-- เลือก Process --</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Machine <span class="text-danger">*</span></label>
                            <div class="position-relative">
                                <input type="text"
                                       asp-for="MachineName"
                                       class="form-control"
                                       id="machineName"
                                       placeholder="พิมพ์ชื่อ Machine..."
                                       required
                                       disabled
                                       autocomplete="off">
                                <!-- Autocomplete Dropdown -->
                                <div class="list-group position-absolute w-100" id="machineAutocomplete" style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>

                        <!-- Hidden fields -->
                        <input type="hidden" asp-for="MachineStorage" id="machineStorage">
                        <input type="hidden" asp-for="Process" id="process">
                    </div>
                </div>
            </div>

            <!-- Additional Information -->
            <div class="card mt-4 d-none" id="additionalCard">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        ข้อมูลเพิ่มเติม
                    </h5>
                </div>
                @* <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label asp-for="Inspector" class="form-label">ผู้ตรวจสอบ</label>
                            <input asp-for="Inspector" class="form-control" placeholder="ชื่อผู้ตรวจสอบ">
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Approver" class="form-label">ผู้อนุมัติ</label>
                            <input asp-for="Approver" class="form-control" placeholder="ชื่อผู้อนุมัติ">
                        </div>

                        <div class="col-12">
                            <label asp-for="Remark" class="form-label">หมายเหตุ</label>
                            <textarea asp-for="Remark" class="form-control" rows="3" placeholder="หมายเหตุเพิ่มเติม..."></textarea>
                        </div>
                    </div>
                </div> *@

                <div class="card-body">
                    <div class="row g-3">
                        <!-- ✅ ผู้ตรวจสอบ กะ A (Dropdown) -->
                        <div class="col-md-4">
                            <label asp-for="InspectorTeamAId" class="form-label">
                                <i class="bi bi-person-check me-1"></i>
                                ผู้ตรวจสอบ กะ A <span class="text-danger">*</span>
                            </label>
                            <select asp-for="InspectorTeamAId"
                                    class="form-select"
                                    asp-items="ViewBag.InspectorsTeamA"
                                    required>
                                <option value="">-- เลือกผู้ตรวจสอบ กะ A --</option>
                            </select>
                            <span asp-validation-for="InspectorTeamAId" class="text-danger"></span>
                        </div>

                        <!-- ✅ ผู้ตรวจสอบ กะ B (Dropdown) -->
                        <div class="col-md-4">
                            <label asp-for="InspectorTeamBId" class="form-label">
                                <i class="bi bi-person-check me-1"></i>
                                ผู้ตรวจสอบ กะ B <span class="text-danger">*</span>
                            </label>
                            <select asp-for="InspectorTeamBId"
                                    class="form-select"
                                    asp-items="ViewBag.InspectorsTeamB"
                                    required>
                                <option value="">-- เลือกผู้ตรวจสอบ กะ B --</option>
                            </select>
                            <span asp-validation-for="InspectorTeamBId" class="text-danger"></span>
                        </div>

                        <!-- ✅ ผู้อนุมัติ (Dropdown) -->
                        @* <div class="col-md-4">
                            <label asp-for="ApproverId" class="form-label">
                                <i class="bi bi-person-check-fill me-1"></i>
                                ผู้อนุมัติ <span class="text-danger">*</span>
                            </label>
                            <select asp-for="ApproverId"
                                    class="form-select"
                                    asp-items="ViewBag.Approvers"
                                    required>
                                <option value="">-- เลือกผู้อนุมัติ --</option>
                            </select>
                            <span asp-validation-for="ApproverId" class="text-danger"></span>
                        </div>

                        <!-- หมายเหตุ -->
                        <div class="col-12">
                            <label asp-for="Remark" class="form-label">
                                <i class="bi bi-chat-left-text me-1"></i>
                                หมายเหตุ
                            </label>
                            <textarea asp-for="Remark"
                                      class="form-control"
                                      rows="3"
                                      placeholder="หมายเหตุเพิ่มเติม..."></textarea>
                            <span asp-validation-for="Remark" class="text-danger"></span>
                        </div> *@
                    </div>
                </div>
            </div>

            <!-- ✅ ปุ่มบันทึก - แก้ไขแล้ว -->
            <div class="d-flex justify-content-between mt-4 d-none" id="actionButtons">
                <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>
                    ยกเลิก
                </a>

                <button type="submit" class="btn btn-primary" id="submitButton">
                    <i class="bi bi-save me-1"></i>
                    สร้างใบตรวจสอบ
                </button>
            </div>
        </form>
    </div>

    <div class="col-lg-4">
        <!-- Help Card -->
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="card-title mb-0">
                    <i class="bi bi-question-circle me-2"></i>
                    คำแนะนำ
                </h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <h6 class="fw-semibold">ขั้นตอนการสร้างใบตรวจสอบ:</h6>
                    <ol class="ps-3">
                        <li class="mb-2">
                            กรอก <strong>Production Order Number</strong> แล้วกดค้นหา
                        </li>
                        <li class="mb-2">
                            ระบบจะดึงข้อมูลตั้งต้นจาก <strong>PP ORDER</strong>
                        </li>
                        <li class="mb-2">
                            ตรวจสอบ <strong>Material Code</strong> ใน <strong>Material Master</strong>
                        </li>
                        <li class="mb-2">
                            หาก <span class="text-success fw-bold">พบ Material Code</span> → แสดงข้อมูลและสามารถบันทึกได้
                        </li>
                        <li class="mb-2">
                            หาก <span class="text-danger fw-bold">ไม่พบ Material Code</span> → ต้องเพิ่มใน Material Master ก่อน
                        </li>
                    </ol>

                    <div class="alert alert-warning small mt-3 mb-0">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <strong>หมายเหตุ:</strong> ต้องมี Material Code ใน Material Master ก่อนจึงจะสามารถสร้างใบตรวจสอบได้
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Card -->
        <div class="card mt-3 d-none" id="previewCard">
            <div class="card-header bg-light">
                <h6 class="card-title mb-0">
                    <i class="bi bi-eye me-2"></i>
                    สถานะการตรวจสอบ
                </h6>
            </div>
            <div class="card-body">
                <div id="previewContent" class="small"></div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

@section Scripts {
    <script>
        let isValidated = false;
        let hasMaterialMaster = false;

        // ✅ Validate Production Order
        async function validateProductionOrder() {
            const productionOrder = document.getElementById('productionOrderInput').value.trim();

            if (!productionOrder) {
                showToast('กรุณากรอก Production Order Number', 'warning');
                return;
            }

            // Show loading
            const searchButton = document.getElementById('searchButton');
            const originalHtml = searchButton.innerHTML;
            searchButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>กำลังค้นหา...';
            searchButton.disabled = true;

            const ppOrder = "0000" + productionOrder;

            try {
                const response = await fetch(`@Url.Action("ValidateProductionOrder")?productionOrder=${encodeURIComponent(ppOrder)}`);
                const result = await response.json();

                if (result.success && result.hasMaterialMaster) {
                    // ✅ Success - พบ Material Master
                    showValidationSuccess(result);
                    fillFormData(result.data);
                    isValidated = true;
                    hasMaterialMaster = true;
                } else if (!result.hasMaterialMaster && result.data) {
                    // ❌ ไม่พบ Material Master แต่มีข้อมูล Production Order
                    showValidationWarning(result);
                    fillFormDataReadOnly(result.data);
                    isValidated = false;
                    hasMaterialMaster = false;
                } else {
                    // ❌ ไม่พบ Production Order เลย
                    showValidationError(result.message);
                    clearForm();
                    isValidated = false;
                    hasMaterialMaster = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'error');
                clearForm();
                isValidated = false;
                hasMaterialMaster = false;
            } finally {
                searchButton.innerHTML = originalHtml;
                searchButton.disabled = false;
            }
        }

        // ✅ แสดง Success
        function showValidationSuccess(result) {
            const statusDiv = document.getElementById('validationStatus');
            const alertDiv = document.getElementById('validationAlert');

            alertDiv.className = 'alert alert-success mb-0';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle me-2"></i>
                <strong>พบข้อมูล!</strong> ${result.message}
            `;

            statusDiv.style.display = 'block';

            // ✅ แก้ไข: ใช้ classList แทน inline style
            document.getElementById('productCard').classList.remove('d-none');
            document.getElementById('additionalCard').classList.remove('d-none');
            document.getElementById('actionButtons').classList.remove('d-none');
            document.getElementById('previewCard').classList.remove('d-none');

            updatePreview('success', result.message, result.materialCode);
            showToast('พบข้อมูลและสามารถบันทึกได้', 'success');
        }

        // ❌ แสดง Warning (ไม่มี Material Master)
        function showValidationWarning(result) {
            const statusDiv = document.getElementById('validationStatus');
            const alertDiv = document.getElementById('validationAlert');

            alertDiv.className = 'alert alert-warning mb-0';
            alertDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>ไม่พบ Material Code!</strong> ${result.message}
                <div class="mt-2">
                    <a href="@Url.Action("Create", "Material")?materialCode=${result.materialCode}"
                       class="btn btn-sm btn-warning">
                        <i class="bi bi-plus-circle me-1"></i>
                        เพิ่ม Material Master
                    </a>
                </div>
            `;

            statusDiv.style.display = 'block';

            // แสดงข้อมูลแต่ซ่อนปุ่มบันทึก
            document.getElementById('productCard').classList.remove('d-none');
            document.getElementById('additionalCard').classList.add('d-none');
            document.getElementById('actionButtons').classList.add('d-none');
            document.getElementById('previewCard').classList.remove('d-none');

            updatePreview('warning', result.message, result.materialCode);
            showToast(result.message, 'warning');
        }

        // ❌ แสดง Error
        function showValidationError(message) {
            const statusDiv = document.getElementById('validationStatus');
            const alertDiv = document.getElementById('validationAlert');

            alertDiv.className = 'alert alert-danger mb-0';
            alertDiv.innerHTML = `
                <i class="bi bi-x-circle me-2"></i>
                <strong>ข้อผิดพลาด!</strong> ${message}
            `;

            statusDiv.style.display = 'block';

            // ซ่อนทุกอย่าง
            document.getElementById('productCard').classList.add('d-none');
            document.getElementById('additionalCard').classList.add('d-none');
            document.getElementById('actionButtons').classList.add('d-none');
            document.getElementById('previewCard').classList.remove('d-none');

            updatePreview('error', message, '');
            showToast(message, 'error');
        }

        // ✅ Fill Form Data (สามารถบันทึกได้)
        function fillFormData(data) {
            document.getElementById('soNumber').value = data.salesOrder || '';
            document.getElementById('soItem').value = data.salesOrderItem || '';
            document.getElementById('customerCode').value = data.customerCode || '';
            document.getElementById('customerName').value = data.customerName || '';
            document.getElementById('materialCode').value = data.materialCode || '';
            document.getElementById('materialName').value = data.materialName || '';
            document.getElementById('size').value = data.size || '';
            document.getElementById('filmType').value = data.filmType || '';
            document.getElementById('plant').value = data.plant || 'KB01';
            document.getElementById('process').value = data.process || '';

            // Remove warning class if exists
            document.getElementById('productCard').classList.remove('border-warning');
        }

        // ❌ Fill Form Data Read-Only
        function fillFormDataReadOnly(data) {
            fillFormData(data);
            document.getElementById('productCard').classList.add('border-warning');
        }

        // Clear Form
        function clearForm() {
            document.getElementById('soNumber').value = '';
            document.getElementById('soItem').value = '';
            document.getElementById('customerCode').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('materialCode').value = '';
            document.getElementById('materialName').value = '';
            document.getElementById('size').value = '';
            document.getElementById('filmType').value = '';
            document.getElementById('plant').value = 'KB01';
            document.getElementById('process').value = '';

            document.getElementById('validationStatus').style.display = 'none';
            document.getElementById('productCard').classList.add('d-none');
            document.getElementById('additionalCard').classList.add('d-none');
            document.getElementById('actionButtons').classList.add('d-none');
            document.getElementById('previewCard').classList.add('d-none');
        }

        // Update Preview
        function updatePreview(status, message, materialCode) {
            const previewContent = document.getElementById('previewContent');

            let icon = '';
            let statusClass = '';

            if (status === 'success') {
                icon = '<i class="bi bi-check-circle-fill text-success fs-4"></i>';
                statusClass = 'text-success';
            } else if (status === 'warning') {
                icon = '<i class="bi bi-exclamation-triangle-fill text-warning fs-4"></i>';
                statusClass = 'text-warning';
            } else {
                icon = '<i class="bi bi-x-circle-fill text-danger fs-4"></i>';
                statusClass = 'text-danger';
            }

            previewContent.innerHTML = `
                <div class="text-center mb-3">${icon}</div>
                <div class="${statusClass} fw-bold mb-2">${message}</div>
                ${materialCode ? `<div class="text-muted">Material Code: <strong>${materialCode}</strong></div>` : ''}
            `;
        }

        // Lost Focus Event
        document.getElementById('productionOrderInput').addEventListener('blur', function() {
            if (this.value.trim() && !isValidated) {
                validateProductionOrder();
            }
        });

        // Enter Key
        document.getElementById('productionOrderInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                validateProductionOrder();
            }
        });

        // Form Validation
        document.getElementById('checklistForm').addEventListener('submit', function(e) {
            if (!isValidated || !hasMaterialMaster) {
                e.preventDefault();
                showToast('กรุณาค้นหาและตรวจสอบ Production Order ก่อนบันทึก', 'warning');
                return false;
            }

            if (!this.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
            }

            this.classList.add('was-validated');
        });

        // Toast Function
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'bg-success' :
                           type === 'error' ? 'bg-danger' :
                           type === 'warning' ? 'bg-warning' : 'bg-primary';

            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast align-items-center text-white ${bgClass} border-0`;
            toast.setAttribute('role', 'alert');

            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        let zones = [];
        let processes = [];
        let machines = [];

        // ✅ 1. โหลด Zones
        async function loadZones() {
            try {
                const response = await fetch('@Url.Action("GetZones", "Checklist")');
                const result = await response.json();

                if (result.success) {
                    zones = result.data;
                    const zoneSelect = document.getElementById('machineZone');
                    zoneSelect.innerHTML = '<option value="">-- เลือก Zone --</option>';

                    zones.forEach(zone => {
                        const option = document.createElement('option');
                        option.value = zone;
                        option.textContent = zone;
                        zoneSelect.appendChild(option);
                    });

                    zoneSelect.disabled = false;
                }
            } catch (error) {
                console.error('Error loading zones:', error);
                showToast('เกิดข้อผิดพลาดในการโหลด Zones', 'error');
            }
        }

        // ✅ 2. โหลด Processes
        async function loadProcesses() {
            const zone = document.getElementById('machineZone').value;

            if (!zone) {
                document.getElementById('machineProcess').innerHTML = '<option value="">-- เลือก Process --</option>';
                document.getElementById('machineProcess').disabled = true;
                document.getElementById('machineName').value = '';
                document.getElementById('machineName').disabled = true;
                return;
            }

            try {
                const url = '@Url.Action("GetProcessesByZone", "Checklist")' + '?zone=' + encodeURIComponent(zone);
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    processes = result.data;
                    const processSelect = document.getElementById('machineProcess');
                    processSelect.innerHTML = '<option value="">-- เลือก Process --</option>';

                    processes.forEach(process => {
                        const option = document.createElement('option');
                        option.value = process;
                        option.textContent = process;
                        processSelect.appendChild(option);
                    });

                    processSelect.disabled = false;
                    document.getElementById('machineName').value = '';
                    document.getElementById('machineName').disabled = true;
                }
            } catch (error) {
                console.error('Error loading processes:', error);
                showToast('เกิดข้อผิดพลาดในการโหลด Processes', 'error');
            }
        }

        // ✅ 3. โหลด Machines
        async function loadMachines() {
            const zone = document.getElementById('machineZone').value;
            const process = document.getElementById('machineProcess').value;

            if (!zone || !process) {
                document.getElementById('machineName').value = '';
                document.getElementById('machineName').disabled = true;
                return;
            }

            try {
                const url = '@Url.Action("GetMachinesByZoneAndProcess", "Checklist")' +
                           '?zone=' + encodeURIComponent(zone) +
                           '&process=' + encodeURIComponent(process);
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    machines = result.data;
                    document.getElementById('machineName').disabled = false;
                    document.getElementById('machineName').focus();
                    document.getElementById('process').value = process;
                    showToast('พบ ' + machines.length + ' เครื่องจักร', 'info');
                }
            } catch (error) {
                console.error('Error loading machines:', error);
                showToast('เกิดข้อผิดพลาดในการโหลด Machines', 'error');
            }
        }

        // ✅ 4. Auto-complete
        const machineInput = document.getElementById('machineName');
        const autocompleteDiv = document.getElementById('machineAutocomplete');

        if (machineInput) {
            machineInput.addEventListener('input', function() {
                const searchTerm = this.value.trim();

                if (searchTerm.length < 1) {
                    autocompleteDiv.style.display = 'none';
                    return;
                }

                const filteredMachines = machines.filter(m =>
                    m.machine.toLowerCase().includes(searchTerm.toLowerCase())
                );

                if (filteredMachines.length === 0) {
                    autocompleteDiv.style.display = 'none';
                    return;
                }

                autocompleteDiv.innerHTML = '';
                filteredMachines.forEach(machine => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';
                    item.innerHTML = '<strong>' + machine.machine + '</strong>' +
                                    '<small class="text-muted ms-2">(' + machine.zone + ' - ' + machine.process + ')</small>';

                    item.onclick = function(e) {
                        e.preventDefault();
                        selectMachine(machine);
                    };

                    autocompleteDiv.appendChild(item);
                });

                autocompleteDiv.style.display = 'block';
            });

            document.addEventListener('click', function(e) {
                if (!machineInput.contains(e.target) && !autocompleteDiv.contains(e.target)) {
                    autocompleteDiv.style.display = 'none';
                }
            });
        }

        // ✅ 5. เลือก Machine
        function selectMachine(machine) {
            document.getElementById('machineName').value = machine.machine;
            document.getElementById('machineStorage').value = machine.storage || '';
            document.getElementById('machineAutocomplete').style.display = 'none';
            showToast('เลือก Machine: ' + machine.machine, 'success');
        }

        // ✅ 6. Hook
        const _originalShowValidationSuccess = showValidationSuccess;
        showValidationSuccess = function(result) {
            _originalShowValidationSuccess(result);
            setTimeout(() => { loadZones(); }, 100);
        };
    </script>
}
