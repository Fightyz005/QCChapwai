@model QcChapWai.Models.InspectionChecklist
@{
    ViewData["Title"] = "ทำรายการตรวจสอบ";
    var inspectionParameters = ViewBag.InspectionParameters as List<QcChapWai.Models.DocumentInspection> ?? new List<QcChapWai.Models.DocumentInspection>();
}

<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        padding: 0;
        margin: 0;
    }
    
    .inspection-header {
        background: linear-gradient(135deg, #0d6efd, #0b5ed7);
        color: white;
        padding: 1rem;
        margin-bottom: 2rem;
        border-radius: 0.5rem;
    }
    
    .product-info-card {
        border: 2px solid #0d6efd;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }
    
    .inspection-table {
        font-size: 12px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .measurement-input {
        width: 100%;
        height: 35px;
        text-align: center;
        font-size: 0.9rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        touch-action: manipulation;
    }
    
    .measurement-input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        transform: scale(1.02);
    }
    
    .measurement-input.pass {
        background-color: #d1e7dd;
        border-color: #198754;
    }
    
    .measurement-input.fail {
        background-color: #f8d7da;
        border-color: #dc3545;
    }
    
    .param-header {
        background-color: #e9ecef;
        font-weight: 600;
        text-align: center;
        // writing-mode: vertical-rl;
        // text-orientation: mixed;
        padding: 8px 4px;
    }
    
    .shift-header {
        background-color: #e9ecef;
        font-weight: 600;
        text-align: center;
    }
    
    .frozen-col {
        position: sticky;
        left: 0;
        z-index: 10;
        background: white;
        border-right: 2px solid #dee2e6;
    }
    
    .summary-card {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 250px;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }



    .modal-parameter-type {
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid #e9ecef;
    }

    .modal-parameter-type:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        border-color: #0d6efd;
    }

    .modal-parameter-type input[type="radio"]:checked + label {  
        background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
        color: white !important;
        border-radius: 0.375rem;
    }

    /* ✅ Fixed: Style when radio is checked */
        .modal-parameter-type input[type="radio"]:checked ~ .card-body,
        .modal-parameter-type input[type="radio"]:checked ~ .card-body label {
            background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
            color: white !important;
            border-radius: 0.375rem;
        }

    .data-type-card {
        cursor: pointer;
        border: 2px solid #e9ecef;
        transition: all 0.2s;
    }

    .data-type-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        border-color: #0d6efd;
    }

    .data-type-card input[type="radio"]:checked + label {
        background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
        color: white !important;
        border-radius: 0.375rem;
    }

    .data-type-card input[type="radio"]:checked ~ .card-body,
        .data-type-card input[type="radio"]:checked ~ .card-body label {
            background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
            color: white !important;
        }

    .number-inputs-section {
        display: none;
    }

    .number-inputs-section.active {
        display: block;
    }
    
    @@media (max-width: 1200px) {
        .summary-card {
            position: relative;
            top: auto;
            right: auto;
            width: 100%;
            margin-bottom: 1rem;
        }
    }
</style>

<!-- Header -->
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1 class="fw-bold text-dark mb-1">
            <i class="bi bi-clipboard-check text-primary me-2"></i>
            Quality Control Inspection Sheet
        </h1>
        <p class="text-muted mb-0">ใบบันทึกการตรวจสอบระหว่างกระบวนการผลิต</p>
    </div>
</div>
<div class="container-fluid">
    <!-- Summary Card -->
    <div class="card summary-card no-print">
        <div class="card-header bg-success text-white">
            <h6 class="mb-0">
                <i class="bi bi-graph-up me-2"></i>
                สรุปผลการตรวจ
            </h6>
        </div>
        <div class="card-body">
            <div class="row text-center g-2">
                <div class="col-6">
                    <div class="h5 text-primary mb-0" id="totalMeasurements">0</div>
                    <small class="text-muted">ทั้งหมด</small>
                </div>
                <div class="col-6">
                    <div class="h5 text-success mb-0" id="passMeasurements">0</div>
                    <small class="text-muted">ผ่าน</small>
                </div>
                <div class="col-6">
                    <div class="h5 text-danger mb-0" id="failMeasurements">0</div>
                    <small class="text-muted">ไม่ผ่าน</small>
                </div>
                <div class="col-6">
                    <div class="h5 text-info mb-0" id="passRate">0%</div>
                    <small class="text-muted">อัตราผ่าน</small>
                </div>
            </div>
            <hr>
            <div class="text-center" id="overallStatus">
                <span class="status-pending">รอการตรวจสอบ</span>
            </div>
        </div>
    </div>

    <!-- Product Information Card -->
    <div class="card product-info-card">
        <div class="card-header bg-primary text-white">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="mb-0">
                        <i class="bi bi-box-seam me-2"></i>
                        ข้อมูลสินค้า
                    </h5>
                </div>
                <div class="col-md-4 text-end">
                    <small>วันที่: <span id="currentDate"></span> | เวลา: <span id="currentTime"></span></small>
                </div>
            </div>
        </div>
        
        <div class="card-body">
            <!-- เพิ่มแถว InspectCode -->
            <div class="row g-3 mb-3">
                <div class="col-md-2">
                    <label class="form-label fw-bold">Inspect Code:</label>
                    <input type="text" class="form-control bg-secondary bg-opacity-25" value="@Model.InspectCode" readonly>
                </div>
                <div class="col-md-1">
                    <label class="form-label fw-bold">Production Order:</label>
                    <input type="text" class="form-control bg-secondary bg-opacity-25" value="@(Model.ProductionOrder != null && Model.ProductionOrder.ToString().Length >= 12 
  ? Model.ProductionOrder.ToString().Substring(4, 8) 
  : (Model.ProductionOrder?.ToString() ?? ""))" readonly>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">SO:</label>
                    <input type="text" class="form-control bg-secondary bg-opacity-25" value="@Model.SoNumber" readonly id="productSo">
                </div>
                <div class="col-md-1">
                    <label class="form-label fw-bold">Item:</label>
                    <input type="text" class="form-control bg-secondary bg-opacity-25" value="@Model.SalesOrderItem" readonly id="productSoItem">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">FG:</label>
                    <input type="text" class="form-control bg-secondary bg-opacity-25" value="@Model.FgCode" readonly id="productFg">
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">ITEM:</label>
                    <input type="text" class="form-control bg-secondary bg-opacity-25" value="@Model.ItemName" readonly id="productItem">
                </div>
            </div>
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-bold">SIZE:</label>
                    <input type="text" class="form-control bg-secondary bg-opacity-25" value="@Model.Size" readonly id="productSize">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">ลูกค้า:</label>
                    <input type="text" class="form-control bg-secondary bg-opacity-25" value="@Model.Customer" readonly id="productCustomer">
                </div>
                
                <div class="col-md-1">
                    <label class="form-label fw-bold">TYPE OF FILM:</label>
                    <input type="text" class="form-control bg-secondary bg-opacity-25" value="@Model.TypeOfFilm" readonly id="productFilm">
                </div>
                <div class="col-md-1">
                    <label class="form-label fw-bold">ประเภทเครื่องจักร:</label>
                    <input type="text" class="form-control bg-secondary bg-opacity-25" value="@Model.Process" readonly id="productProcess">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">ZONE:</label>
                    <input type="text" class="form-control bg-secondary bg-opacity-25" value="@Model.MachineZone" readonly id="productZone">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">MACHINE:</label>
                    <input type="text" class="form-control bg-secondary bg-opacity-25" value="@Model.MachineName" readonly id="productMachine">
                </div>
            </div>

            <!-- ✅ Control Buttons - สลับตำแหน่ง -->
            <div class="mt-3 no-print">
                <div class="row g-2">
                    <div class="col-12 col-md-8">
                        <div class="d-flex flex-wrap gap-2">
                            
                            <!-- ✅ เพิ่มรายการตรวจ (ปุ่มที่สอง) -->
                            <button class="btn btn-success" onclick="addInspectionRow()">
                                <i class="bi bi-plus-circle me-1"></i>
                                เพิ่มรายการตรวจ
                            </button>
                            <!--<button class="btn btn-outline-secondary" onclick="clearAllData()">
                                <i class="bi bi-trash me-1"></i>
                                ล้างข้อมูล
                            </button>-->
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="d-flex flex-wrap gap-2 justify-content-md-end">
                            <!-- <button class="btn btn-outline-info" onclick="exportToCSV()">
                                <i class="bi bi-download me-1"></i>
                                Export
                            </button>
                            <button class="btn btn-outline-secondary" onclick="window.print()">
                                <i class="bi bi-printer me-1"></i>
                                พิมพ์
                            </button>-->
                            <button class="btn btn-primary" onclick="saveInspection()">
                                <i class="bi bi-save me-1"></i>
                                บันทึก
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inspection Table -->
    <div class="card">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">
                <i class="bi bi-table me-2"></i>
                ตารางบันทึกการตรวจสอบ
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="inspection-table">
                <table class="table table-bordered mb-0" id="inspectionTable">
                    <thead>
                        <tr>
                            <th class="frozen-col shift-header" style="min-width: 60px;">กะ</th>
                            <th class="frozen-col shift-header" style="min-width: 80px;">เวลา</th>
                            <th class="frozen-col shift-header" style="min-width: 80px;max-width:120px;">บันทึกการตรวจสอบ</th>
                        </tr>
                        <tr id="parametersHeaderRow">
                            <th class="frozen-col param-header">Shift</th>
                            <th class="frozen-col param-header">Time</th>
                            <th class="frozen-col param-header">Record</th>
                        </tr>
                    </thead>
                    <tbody id="inspectionTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Remarks Section -->
    <div class="card mt-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">
                <i class="bi bi-chat-dots me-2"></i>
                หมายเหตุและความเห็นเพิ่มเติม
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">หมายเหตุการตรวจสอบ:</label>
                    <textarea class="form-control" rows="4" id="inspectionRemark">@Model.Remark</textarea>
                </div>
                <div class="col-md-6">
                    <label class="form-label">ผู้ตรวจสอบกะ A:</label>
                    @{
                        string teamA = "";
                        string teamB = "";
                    }
                    @if (Model.InspectorTeamA == "44")
                    {
                        teamA = "นางบุษบง เถื่อนยศ";
                    }
                    else if (Model.InspectorTeamA == "43")
                    {
                        teamA = "นางสาวชบาไพร ภูงามนิล";
                    }
                    @if (Model.InspectorTeamB == "51")
                    {
                        teamB = "นางนราภรณ์ คลังพรมอินทร์";
                    }
                    else if (Model.InspectorTeamB == "52")
                    {
                        teamB = "นางสาวปัญจมาพร บุตรศรี";
                    }
                    <input type="text" class="form-control mb-2 bg-secondary bg-opacity-25" id="InspectorTeamAId" value="@(teamA ?? "-")" readonly>
                    <label class="form-label">ผู้ตรวจสอบกะ B:</label>
                    <input type="text" class="form-control bg-secondary bg-opacity-25" id="InspectorTeamBId" value="@(teamB ?? "-")" readonly>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="mt-4 mb-4 no-print">
        <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>
            กลับไปรายการ
        </a>
    </div>
</div>



<!-- Modal: เพิ่มพารามิเตอร์ -->
<div class="modal fade" id="addParameterModal" tabindex="-1" aria-labelledby="addParameterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addParameterModalLabel">
                    <i class="bi bi-plus-square me-2"></i>
                    เพิ่มพารามิเตอร์การตรวจสอบใหม่
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addParameterForm">
                    <!-- ✅ 1. ประเภทข้อมูล (ตัด/เป่า/พิมพ์) - NEW! -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-tag me-1"></i>
                            ประเภทข้อมูล <span class="text-danger">*</span>
                        </label>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="card data-type-card h-100" style="cursor: pointer; border: 2px solid #e9ecef; transition: all 0.2s;">
                                    <div class="card-body text-center p-3">
                                        <input type="radio" name="dataType" value="เป่า, เป่า-พิมพ์" id="dataTypeBlow" class="d-none">
                                        <label for="dataTypeBlow" class="w-100 h-100 d-flex flex-column justify-content-center mb-0" style="cursor: pointer;">
                                            <div class="d-inline">
                                                <i class="bi bi-wind fs-2 text-info mb-2"></i>
                                                <i class="bi bi-printer fs-2 text-warning mb-2"></i>
                                            </div>
                                            <strong>เป่า, เป่า-พิมพ์</strong>
                                            <small class="text-muted">BLOW, BLOW-PRINT</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-2">
                                <div class="card data-type-card h-100" style="cursor: pointer; border: 2px solid #e9ecef; transition: all 0.2s;">
                                    <div class="card-body text-center p-3">
                                        <input type="radio" name="dataType" value="พิมพ์" id="dataTypePrint" class="d-none">
                                        <label for="dataTypePrint" class="w-100 h-100 d-flex flex-column justify-content-center mb-0" style="cursor: pointer;">
                                            <i class="bi bi-printer fs-2 text-warning mb-2"></i>
                                            <strong>พิมพ์</strong>
                                            <small class="text-muted">OUTLINE</small>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="card data-type-card h-100" style="cursor: pointer; border: 2px solid #e9ecef; transition: all 0.2s;">
                                    <div class="card-body text-center p-3">
                                        <input type="radio" name="dataType" value="ตัด-บรรจุ" id="dataTypeCut" class="d-none" checked>
                                        <label for="dataTypeCut" class="w-100 h-100 d-flex flex-column justify-content-center mb-0" style="cursor: pointer;">
                                            <div class="d-inline">
                                                <i class="bi bi-scissors fs-2 text-danger mb-2"></i>
                                                <i class="bi bi-box-seam fs-2 text-success mb-2"></i>
                                            </div>
                                            <strong>ตัด-บรรจุ</strong>
                                            <small class="text-muted">CUT-PACK</small>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card data-type-card h-100" style="cursor: pointer; border: 2px solid #e9ecef; transition: all 0.2s;">
                                    <div class="card-body text-center p-3">
                                        <input type="radio" name="dataType" value="เป่า-พิมพ์-ตัด-บรรจุ" id="dataTypeBlowPrintCutPack" class="d-none">
                                        <label for="dataTypeBlowPrintCutPack" class="w-100 h-100 d-flex flex-column justify-content-center mb-0" style="cursor: pointer;">
                                            <div class="d-inline">
                                                <i class="bi bi-wind fs-2 text-info mb-2"></i>
                                                <i class="bi bi-printer fs-2 text-warning mb-2"></i>
                                                <i class="bi bi-scissors fs-2 text-danger mb-2"></i>
                                                <i class="bi bi-box-seam fs-2 text-success mb-2"></i>
                                            </div>     
                                            <strong>เป่า-พิมพ์-ตัด-บรรจุ</strong>
                                            <small class="text-muted">BLOW-PRINT-CUT-PACK</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ประเภทการตรวจสอบ -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-collection me-1"></i>
                            ประเภทการตรวจสอบ <span class="text-danger">*</span>
                        </label>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card modal-parameter-type h-100">
                                    <div class="card-body text-center">
                                        <input type="radio" name="parameterType" value="number" id="typeNumber" class="d-none" checked>
                                        <label for="typeNumber" class="w-100 h-100 d-flex flex-column justify-content-center" style="cursor: pointer;">
                                            <i class="bi bi-123 fs-2 text-dark mb-2"></i>
                                            <strong>ค่าตัวเลข</strong>
                                            <small class="text-muted">มี Min, Max, Std</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card modal-parameter-type h-100">
                                    <div class="card-body text-center">
                                        <input type="radio" name="parameterType" value="leftright" id="typeLeftRight" class="d-none">
                                        <label for="typeLeftRight" class="w-100 h-100 d-flex flex-column justify-content-center" style="cursor: pointer;">
                                            <i class="bi bi-arrow-left-right fs-2 text-dark mb-2"></i>
                                            <strong>ซ้าย/ขวา</strong>
                                            <small class="text-muted">ไม่ต้องกรอก Min/Max</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card modal-parameter-type h-100">
                                    <div class="card-body text-center">
                                        <input type="radio" name="parameterType" value="passfail" id="typePassFail" class="d-none">
                                        <label for="typePassFail" class="w-100 h-100 d-flex flex-column justify-content-center" style="cursor: pointer;">
                                            <i class="bi bi-check-circle fs-2 text-success mb-2"></i>
                                            <strong>ปกติ/ไม่ปกติ</strong>
                                            <small class="text-muted">ไม่ต้องกรอก Min/Max</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- รายละเอียดพารามิเตอร์ -->
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label for="modalDocInspection" class="form-label">
                                ชื่อการตรวจสอบ <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="modalDocInspection" 
                                   placeholder="เช่น ความกว้าง, ความยาว, ความหนา" required>
                        </div>
                        <div class="col-md-4">
                            <label for="modalDocUnit" class="form-label">
                                หน่วย <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="modalDocUnit" required>
                                <option value="cm">cm</option>
                                <option value="mm">mm</option>
                                <option value="mic">mic</option>
                                <option value="g">g</option>
                                <option value="kg">kg</option>
                                <option value="%">%</option>
                                <option value="N/mm²">N/mm²</option>
                                <option value="-">-</option>
                            </select>
                        </div>
                    </div>

                    <!-- ค่าตัวเลข (แสดงเฉพาะเลือก "ค่าตัวเลข") -->
                    <div class="number-inputs-section active mt-3" id="numberInputsSection">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-1"></i>
                            กรอกค่า Min, Max, Standard สำหรับการตรวจแบบตัวเลข
                        </div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="modalDocMin" class="form-label">ค่าต่ำสุด (Min)</label>
                                <input type="number" step="0.01" class="form-control" id="modalDocMin" placeholder="0.00">
                            </div>
                            <div class="col-md-4">
                                <label for="modalDocStd" class="form-label">ค่ามาตรฐาน (Std)</label>
                                <input type="number" step="0.01" class="form-control" id="modalDocStd" placeholder="0.00">
                            </div>
                            <div class="col-md-4">
                                <label for="modalDocMax" class="form-label">ค่าสูงสุด (Max)</label>
                                <input type="number" step="0.01" class="form-control" id="modalDocMax" placeholder="0.00">
                            </div>
                        </div>
                    </div>

                    <!-- หมายเหตุ -->
                    <div class="mt-3">
                        <label for="modalDocRemark" class="form-label">หมายเหตุ</label>
                        <textarea class="form-control" id="modalDocRemark" rows="2" 
                                  placeholder="หมายเหตุเพิ่มเติม (ถ้ามี)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>
                    ยกเลิก
                </button>
                <button type="button" class="btn btn-primary" onclick="submitAddParameter()">
                    <i class="bi bi-save me-1"></i>
                    บันทึก
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

@section Scripts {
    <script>
        const checklistId = @Model.ChecklistId;
        
        // ✅ Load inspection parameters - เพิ่ม isMm flag
        const inspectionParameters = @Html.Raw(Json.Serialize(inspectionParameters.Select(m => new {
            id = "param_" + m.DocId,
            docId = m.DocId,
            nameTH = m.DocInspection,
            unit = m.DocUnit,
            min = m.DocMin,
            max = m.DocMax,
            std = m.DocStd,
            isLr = m.DocIsLr,
            isMm = m.DocIsMm,
            docDataType = m.DocDataType,
            type = m.DocIsLr ? "leftright" : (m.DocIsMm ? "passfail" : "number"),
            hasSpec = true,
            
        })));

        let inspectionRows = [];

        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            generateInspectionTable();
            initializeWithDefaultRows();
            loadExistingData();

            // Radio Button Change Event
            const parameterTypeRadios = document.querySelectorAll('input[name="parameterType"]');
            parameterTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const numberSection = document.getElementById('numberInputsSection');
                    if (this.value === 'number') {
                        numberSection.classList.add('active');
                        document.getElementById('modalDocMin').required = true;
                        document.getElementById('modalDocStd').required = true;
                        document.getElementById('modalDocMax').required = true;
                    } else {
                        numberSection.classList.remove('active');
                        document.getElementById('modalDocMin').value = '';
                        document.getElementById('modalDocStd').value = '';
                        document.getElementById('modalDocMax').value = '';
                        document.getElementById('modalDocMin').required = false;
                        document.getElementById('modalDocStd').required = false;
                        document.getElementById('modalDocMax').required = false;
                    }
                });
            });
        });

        function submitAddParameter() {
            const parameterType = document.querySelector('input[name="parameterType"]:checked').value;
            const docInspection = document.getElementById('modalDocInspection').value.trim();
            const docUnit = document.getElementById('modalDocUnit').value;
            const docDataType = document.querySelector('input[name="dataType"]:checked').value;
            
            if (!docInspection) {
                showToast('กรุณากรอกชื่อการตรวจสอบ', 'warning');
                return;
            }

            if (!docUnit) {
                showToast('กรุณาเลือกหน่วย', 'warning');
                return;
            }

            if (!docDataType) {
                showToast('กรุณาเลือกประเภท', 'warning');
                return;
            }

            let docMin = null, docMax = null, docStd = null;

            if (parameterType === 'number') {
                docMin = parseFloat(document.getElementById('modalDocMin').value);
                docMax = parseFloat(document.getElementById('modalDocMax').value);
                docStd = parseFloat(document.getElementById('modalDocStd').value);


                if (isNaN(docMin) || isNaN(docMax) || isNaN(docStd)) {
                    showToast('กรุณากรอกค่า Min, Max, Std ให้ครบถ้วน', 'warning');
                    return;
                }

                if (docMin >= docMax) {
                    showToast('ค่า Min ต้องน้อยกว่า Max', 'warning');
                    return;
                }

                if (docStd < docMin || docStd > docMax) {
                    showToast('ค่า Standard ต้องอยู่ระหว่าง Min และ Max', 'warning');
                    return;
                }
            }

            const requestData = {
                docFg: document.getElementById('productFg').value,
                docFgItem: document.getElementById('productItem').value,
                docCustomer: document.getElementById('productCustomer').value,
                docPlant: document.getElementById('productPlant')?.value || 'KB01',
                docProcess: document.getElementById('productProcess').value,
                docSize: document.getElementById('productSize').value,
                docTypeOfFilm: document.getElementById('productFilm').value,
                docSo: document.getElementById('productSo').value,
                parameterType: parameterType,
                docInspection: docInspection,
                docUnit: docUnit,
                docMin: docMin,
                docMax: docMax,
                docStd: docStd,
                docRemark: document.getElementById('modalDocRemark').value,
                docDataType: docDataType
            };

            const submitBtn = document.querySelector('#addParameterModal .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>กำลังบันทึก...';
            submitBtn.disabled = true;

            fetch('@Url.Action("AddInspectionParameter", "Material")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('✅ ' + data.message, 'success');
                    
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addParameterModal'));
                    modal.hide();
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showToast('❌ ' + data.message, 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('เกิดข้อผิดพลาดในการบันทึก', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }

        document.getElementById('addParameterModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('addParameterForm').reset();
            document.querySelector('input[name="parameterType"][value="number"]').checked = true;
            document.getElementById('numberInputsSection').classList.add('active');
        });

        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('th-TH');
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'});
        }

        function generateInspectionTable() {
            const headerRow = document.getElementById('parametersHeaderRow');
            
            inspectionParameters.forEach(param => {
                const th = document.createElement('th');
                th.className = 'param-header';
                th.style.minWidth = '40px';
                th.style.maxWidth = '50px';
                th.innerHTML = `
                    <div>
                        <strong>${param.docDataType}</strong><hr/>
                        <strong>${param.nameTH}</strong>
                        <small>(${param.unit})</small>
                        ${param.type === 'number' ? `<br><small>Min: ${param.min} | Max: ${param.max}</small>` : ''}
                    </div>
                `;
                headerRow.appendChild(th);
            });
            
            const emptyTh = document.createElement('th');
            //emptyTh.style.alignItems = 'center';
            emptyTh.innerHTML = `
                                <button class="btn btn-info" style="width:100%;" data-bs-toggle="modal" data-bs-target="#addParameterModal">
                                    <i class="bi bi-plus-square me-1"></i>
                                    เพิ่มคุณสมบัติ
                                </button>`;
            headerRow.appendChild(emptyTh);
        }

        function initializeWithDefaultRows() {
            inspectionRows = [
                { shift: 'A', time: '08:00', note: '' }
            ];
            renderInspectionRows();
        }

        function loadExistingData() {
            const existingRecords = @Html.Raw(Json.Serialize(ViewBag.ExistingRecords ?? new List<object>()));
    
            if (existingRecords && existingRecords.length > 0) {
                inspectionRows = [];
        
                existingRecords.forEach(record => {
                    inspectionRows.push({
                        shift: record.shift,
                        time: record.time,
                        note: record.note || ''
                    });
                });
        
                renderInspectionRows();
        
                setTimeout(() => {
                    existingRecords.forEach((record, rowIdx) => {
                        record.measurements.forEach(measurement => {
                            const input = document.querySelector(
                                `.measurement-input[data-param="${measurement.parameterId}"][data-row-index="${rowIdx}"]`
                            );
                    
                            if (input) {
                                if (measurement.measurementType === 'number') {
                                    input.value = measurement.value || measurement.numericValue || '';
                            
                                    if (input.value) {
                                        const param = inspectionParameters.find(p => p.id === measurement.parameterId);
                                        if (param) {
                                            validateMeasurement(input, param);
                                        }
                                    }
                                } else if (measurement.measurementType === 'leftright' || measurement.measurementType === 'passfail') {
                                    input.value = measurement.value || (measurement.measurementType === 'leftright' ? 'ซ้าย' : 'ปกติ');
                                    validateDropdown(input);
                                }
                            }
                        });
                    });
            
                    updateSummary();
                }, 100);
            } else {
                initializeWithDefaultRows();
            }
        }

        function addInspectionRow() {
            const now = new Date();
            const newRow = { 
                shift: 'A', 
                time: now.toTimeString().substring(0, 5), 
                note: '' 
            };
    
            const currentValues = saveCurrentValues();
            inspectionRows.push(newRow);
            renderInspectionRows();
            restoreValues(currentValues);
            updateSummary();
    
            showToast('เพิ่มรายการตรวจสอบใหม่แล้ว', 'success');
        }

        function renderInspectionRows() {
            const tbody = document.getElementById('inspectionTableBody');
            tbody.innerHTML = '';

            inspectionRows.forEach((row, idx) => {
                const tr = document.createElement('tr');
        
                const shiftCell = document.createElement('td');
                shiftCell.className = 'frozen-col text-center';
                shiftCell.style.backgroundColor = '#f8f9fa';
                const shiftSelect = document.createElement('select');
                shiftSelect.className = 'form-select form-select-sm';
                shiftSelect.innerHTML = `
                    <option value="A" ${row.shift === 'A' ? 'selected' : ''}>A</option>
                    <option value="B" ${row.shift === 'B' ? 'selected' : ''}>B</option>
                `;
                shiftSelect.onchange = () => {
                    inspectionRows[idx].shift = shiftSelect.value;
                };
                shiftCell.appendChild(shiftSelect);
                tr.appendChild(shiftCell);

                const timeCell = document.createElement('td');
                timeCell.className = 'frozen-col text-center';
                timeCell.style.backgroundColor = '#f8f9fa';
                const timeInput = document.createElement('input');
                timeInput.type = 'time';
                timeInput.className = 'form-control form-control-sm';
                timeInput.value = row.time;
                timeInput.onchange = () => {
                    inspectionRows[idx].time = timeInput.value;
                };
                timeCell.appendChild(timeInput);
                tr.appendChild(timeCell);

                const noteCell = document.createElement('td');
                noteCell.className = 'frozen-col';
                noteCell.style.backgroundColor = '#f8f9fa';
                const noteInput = document.createElement('input');
                noteInput.type = 'text';
                noteInput.className = 'form-control form-control-sm';
                noteInput.placeholder = 'Lot number ex: 13009211';
                noteInput.value = row.note || '';
                noteInput.onchange = () => {
                    inspectionRows[idx].note = noteInput.value;
                };
                noteCell.appendChild(noteInput);
                tr.appendChild(noteCell);

                inspectionParameters.forEach(param => {
                    const cell = document.createElement('td');
                    cell.style.padding = '.5rem';
            
                    // ✅ เช็ค Type: leftright, passfail, number
                    if (param.type === 'leftright') {
                        const select = document.createElement('select');
                        select.className = 'form-select form-select-sm measurement-input';
                        select.dataset.param = param.id;
                        select.dataset.rowIndex = idx;
                        select.dataset.type = 'leftright';
                        select.innerHTML = `
                            <option value="ซ้าย">ซ้าย</option>
                            <option value="ขวา">ขวา</option>
                        `;
                        select.onchange = () => validateDropdown(select);
                        cell.appendChild(select);
                    } else if (param.type === 'passfail') {
                        // ✅ DocIsMm = 1 → Dropdown "ปกติ/ไม่ปกติ"
                        const select = document.createElement('select');
                        select.className = 'form-select form-select-sm measurement-input';
                        select.dataset.param = param.id;
                        select.dataset.rowIndex = idx;
                        select.dataset.type = 'passfail';
                        select.innerHTML = `
                            <option value="ปกติ">ปกติ</option>
                            <option value="ไม่ปกติ">ไม่ปกติ</option>
                        `;
                        select.onchange = () => validateDropdown(select);
                        cell.appendChild(select);
                    } else {
                        // Number input
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.step = '1.00';
                        input.className = 'measurement-input';
                        input.dataset.param = param.id;
                        input.dataset.rowIndex = idx;
                        input.dataset.type = 'number';
                        input.placeholder = param.unit;
                        input.oninput = () => validateMeasurement(input, param);
                        cell.appendChild(input);
                    }
            
                    tr.appendChild(cell);
                });

                const deleteCell = document.createElement('td');
                deleteCell.style.textAlign = 'center';
                if (inspectionRows.length > 1) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-outline-danger';
                    deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                    deleteBtn.onclick = () => removeRow(idx);
                    deleteBtn.title = 'ลบรายการนี้';
                    deleteCell.appendChild(deleteBtn);
                }
                tr.appendChild(deleteCell);

                tbody.appendChild(tr);
            });
        }

        function saveCurrentValues() {
            const values = [];
    
            document.querySelectorAll('.measurement-input[data-type="number"]').forEach(input => {
                if (input.value) {
                    values.push({
                        param: input.dataset.param,
                        rowIndex: input.dataset.rowIndex,
                        type: 'number',
                        value: input.value,
                        classes: input.className
                    });
                }
            });
    
            document.querySelectorAll('.measurement-input[data-type="leftright"], .measurement-input[data-type="passfail"]').forEach(select => {
                if (select.value) {
                    values.push({
                        param: select.dataset.param,
                        rowIndex: select.dataset.rowIndex,
                        type: select.dataset.type,
                        value: select.value,
                        classes: select.className
                    });
                }
            });
    
            document.querySelectorAll('#inspectionTableBody tr').forEach((tr, idx) => {
                const shiftSelect = tr.querySelector('select.form-select');
                const timeInput = tr.querySelector('input[type="time"]');
                const noteInput = tr.querySelector('input[type="text"]');
        
                if (idx < inspectionRows.length) {
                    inspectionRows[idx].shift = shiftSelect?.value || 'A';
                    inspectionRows[idx].time = timeInput?.value || '08:00';
                    inspectionRows[idx].note = noteInput?.value || '';
                }
            });
    
            return values;
        }

        function restoreValues(savedValues) {
            setTimeout(() => {
                savedValues.forEach(saved => {
                    const selector = `.measurement-input[data-param="${saved.param}"][data-row-index="${saved.rowIndex}"]`;
                    const element = document.querySelector(selector);
            
                    if (element) {
                        element.value = saved.value;
                        element.className = saved.classes;
                    }
                });
        
                updateSummary();
            }, 50);
        }

        function validateMeasurement(input, param) {
            const value = parseFloat(input.value);
            
            input.classList.remove('pass', 'fail');
            
            if (input.value && !isNaN(value)) {
                let isValid = true;
                
                if (param.min !== null && value < param.min) {
                    isValid = false;
                }
                
                if (param.max !== null && value > param.max) {
                    isValid = false;
                }
                
                if (isValid) {
                    input.classList.add('pass');
                } else {
                    input.classList.add('fail');
                }
            }
            
            updateSummary();
        }

        // ✅ Validate Dropdown (ทั้ง leftright และ passfail)
        function validateDropdown(select) {
            select.classList.remove('pass', 'fail');
            if (select.value) {
                // ถ้าเป็น passfail และเลือก "ไม่ปกติ" ให้เป็นสีแดง
                if (select.dataset.type === 'passfail' && select.value === 'ไม่ปกติ') {
                    select.classList.add('fail');
                } else {
                    select.classList.add('pass');
                }
            }
            updateSummary();
        }

        function updateSummary() {
            const numberInputs = document.querySelectorAll('.measurement-input[data-type="number"]');
            const dropdowns = document.querySelectorAll('.measurement-input[data-type="leftright"], .measurement-input[data-type="passfail"]');
            
            let total = 0, pass = 0, fail = 0;

            numberInputs.forEach(input => {
                if (input.value && input.value.trim() !== '') {
                    total++;
                    if (input.classList.contains('pass')) {
                        pass++;
                    } else if (input.classList.contains('fail')) {
                        fail++;
                    }
                }
            });

            dropdowns.forEach(select => {
                if (select.value && select.value.trim() !== '') {
                    total++;
                    if (select.classList.contains('pass')) {
                        pass++;
                    } else if (select.classList.contains('fail')) {
                        fail++;
                    }
                }
            });

            document.getElementById('totalMeasurements').textContent = total;
            document.getElementById('passMeasurements').textContent = pass;
            document.getElementById('failMeasurements').textContent = fail;
            
            const passRate = total > 0 ? Math.round((pass / total) * 100) : 0;
            document.getElementById('passRate').textContent = passRate + '%';

            const statusElement = document.getElementById('overallStatus');
            if (total === 0) {
                statusElement.innerHTML = '<span class="status-pending">รอการตรวจสอบ</span>';
            } else if (fail === 0) {
                statusElement.innerHTML = '<span class="status-pass">ผ่านการตรวจสอบทั้งหมด</span>';
            } else {
                statusElement.innerHTML = `<span class="status-fail">มีรายการไม่ผ่าน ${fail} รายการ</span>`;
            }
        }

        function removeRow(idx) {
            if (inspectionRows.length <= 1) {
                showToast('ต้องมีรายการตรวจสอบอย่างน้อย 1 รายการ', 'warning');
                return;
            }
    
            if (confirm('ต้องการลบรายการตรวจสอบนี้หรือไม่?')) {
                const currentValues = saveCurrentValues();
                inspectionRows.splice(idx, 1);
                renderInspectionRows();
        
                const adjustedValues = currentValues
                    .filter(v => parseInt(v.rowIndex) !== idx)
                    .map(v => {
                        const rowIndex = parseInt(v.rowIndex);
                        return {
                            ...v,
                            rowIndex: rowIndex > idx ? (rowIndex - 1).toString() : v.rowIndex
                        };
                    });
        
                restoreValues(adjustedValues);
                updateSummary();
        
                showToast('ลบรายการแล้ว', 'info');
            }
        }

        function clearAllData() {
            if (confirm('ต้องการล้างข้อมูลทั้งหมดหรือไม่?')) {
                initializeWithDefaultRows();
                updateSummary();
                showToast('ล้างข้อมูลเรียบร้อย', 'info');
            }
        }

        function saveInspection() {
            const data = collectInspectionData();
            
            if (data.measurements.length === 0) {
                showToast('ไม่มีข้อมูลการตรวจสอบให้บันทึก', 'warning');
                return;
            }

            fetch('@Url.Action("SaveInspectionData", "Checklist")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('บันทึกข้อมูลสำเร็จ', 'success');
                } else {
                    showToast('เกิดข้อผิดพลาด: ' + result.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error');
            });
        }

        function collectInspectionData() {
            const measurements = [];
    
            const numberInputs = document.querySelectorAll('.measurement-input[data-type="number"]');
            numberInputs.forEach(input => {
                if (input.value && input.value.trim() !== '') {
                    const param = inspectionParameters.find(p => p.id === input.dataset.param);
                    measurements.push({
                        parameter: input.dataset.param,
                        parameterName: param?.nameTH || '',
                        rowIndex: parseInt(input.dataset.rowIndex),
                        shift: inspectionRows[parseInt(input.dataset.rowIndex)]?.shift || '',
                        time: inspectionRows[parseInt(input.dataset.rowIndex)]?.time || '',
                        value: input.value,
                        unit: param?.unit || '',
                        type: 'number',
                        passed: input.classList.contains('pass'),
                        failed: input.classList.contains('fail'),
                        minValue: param?.min,
                        maxValue: param?.max,
                        standardValue: param?.std
                    });
                }
            });

            const dropdowns = document.querySelectorAll('.measurement-input[data-type="leftright"], .measurement-input[data-type="passfail"]');
            dropdowns.forEach(select => {
                if (select.value && select.value.trim() !== '') {
                    const param = inspectionParameters.find(p => p.id === select.dataset.param);
                    measurements.push({
                        parameter: select.dataset.param,
                        parameterName: param?.nameTH || '',
                        rowIndex: parseInt(select.dataset.rowIndex),
                        shift: inspectionRows[parseInt(select.dataset.rowIndex)]?.shift || '',
                        time: inspectionRows[parseInt(select.dataset.rowIndex)]?.time || '',
                        value: select.value,
                        unit: '-',
                        type: select.dataset.type,
                        passed: select.classList.contains('pass'),
                        failed: select.classList.contains('fail'),
                        minValue: null,
                        maxValue: null,
                        standardValue: null
                    });
                }
            });

            return {
                checklistId: checklistId,
                inspectionRows: inspectionRows,
                measurements: measurements,
                remark: document.getElementById('inspectionRemark').value
            };
        }

        function exportToCSV() {
            const data = collectInspectionData();
            
            if (data.measurements.length === 0) {
                showToast('ไม่มีข้อมูลสำหรับ Export', 'warning');
                return;
            }

            const headers = ['กะ', 'เวลา', 'พารามิเตอร์', 'ค่าที่วัดได้', 'หน่วย', 'ประเภท', 'ผลการตรวจ'];
            let csvContent = headers.join(',') + '\n';
            
            data.measurements.forEach(m => {
                const row = [
                    m.shift,
                    m.time,
                    m.parameterName,
                    m.value,
                    m.unit,
                    m.type === 'number' ? 'วัดค่า' : (m.type === 'leftright' ? 'ซ้าย/ขวา' : 'ปกติ/ไม่ปกติ'),
                    m.passed ? 'ผ่าน' : m.failed ? 'ไม่ผ่าน' : 'N/A'
                ];
                csvContent += row.map(field => `"${field}"`).join(',') + '\n';
            });

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `QC_Inspection_${checklistId}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Export ข้อมูลเรียบร้อย', 'success');
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'bg-success' : 
                           type === 'error' ? 'bg-danger' : 
                           type === 'warning' ? 'bg-warning' : 'bg-primary';
            
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast align-items-center text-white ${bgClass} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }
    </script>
}
